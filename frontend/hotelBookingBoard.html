<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map_canvas { height: 100% }
      #map_title {
        position: absolute;
        top: 30px;
        left: 50px;
        font-size: 35px;
        font-family: sans-serif;
        text-shadow: 0.1em 0.1em 0.2em black;
        color: white;
      }
      #city_board {
        position: absolute;
        top: 45px;
        left: 350px;
        font-size: 20px;
        font-family: sans-serif;
        text-shadow: 0.1em 0.1em 0.2em black;
        color: white;
      }
    </style>
      <script type="text/javascript" 
      src="http://maps.googleapis.com/maps/api/js?key=AIzaSyC5AdIXriwJl1vhMcbm661l3b5EF8QuIZk&sensor=false">
    <script type="text/javascript" src="scripts/getHTTPObject.js"></script>
    <script type="text/javascript" src="scripts/updateBookingList.js"></script>
    </script>
    <script type="text/javascript">
      // 地图控件实例
      var map;

      // 预订任务队列
      var bookings_queue = [];

      // 定时器
      var syncInterval = 5*1000; //ms
      var displayInterval = 200; //ms
      var colors = [];

      //var markersByMonth = [];
      //for (var i = 0; i < 12; ++i) {
      //  markersByMonth.push([]);
      //}

      function initialize() {
        /*
        var mapOptions = {
          center: new google.maps.LatLng(37.550,115.579), // JiZhou Municipal Government
          zoom: 5,
          mapTypeId: google.maps.MapTypeId.TERRAIN
        };
        */

        // 配置地图属性
        var mapOptions = {
          zoom: 5,
          center: new google.maps.LatLng(37.550,115.579), // JiZhou Municipal Government
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          mapTypeControl: false,
          backgroundColor: 'white',
          zoomControl: true,
          streetViewControl: false,
          panControl: false,
          styles: [
            {
              stylers: [
                { visibility: "off" }
              ]
            },{
              featureType: "water",
              stylers: [
                { visibility: "on" },
                { lightness: -50 },
                { saturation: -100 }
              ]
            },{
              featureType: "administrative.province",
              elementType: "geometry",
              stylers: [
                { visibility: "on" }
              ]
            },{
              featureType: "administrative.country",
              elementType: "geometry",
              stylers: [
                { visibility: "on" }
              ]
            },{
              featureType: "water",
              elementType: "labels",
              stylers: [
                { visibility: "off" }
              ]
            }
          ]
        };

        // 初始化地图实例
        map = new google.maps.Map(document.getElementById("map_canvas"),
            mapOptions);

        // 标记地点
        /*
        var myKuxunLatLng = new google.maps.LatLng(39.960,116.323)
        var myKuxunMarker = new google.maps.Marker({
          position: myKuxunLatLng,
          title: "酷讯旅游在这里！"
        });
        myKuxunMarker.setMap(map);
        */

        // 初始化颜色列表
        fillColorArray();

        // 设置数据同步定时器
        syncTimer();

        // 设置展示定时器
        displayTimer();
      }

      function syncTimer() {
        // sync data
        updateBookingList(storeAsyncRespData, errorHandler);

        // set next sync timer
        setTimeout(syncTimer, syncInterval);
      }

      function displayTimer() {
        // 标记展示
        while (booking = bookings_queue.shift())
        {
          displayAOrder(booking['city_name'], booking['coords'], 2015, 5);
          //console.log("%s %s (%s,%s)", booking['city'], booking['city_name'], booking['coords'][0], booking['coords'][1]);
          break;
        }

        // WARNING: 任务积累异常处理 dump display 机制（兜底机制）
        if (bookings_queue.length > 1000) {
          len_a = bookings_queue.length;
          for (var i = 0; i < 500; i++) {
            booking = bookings_queue.shift();
            displayAOrder(booking['city_name'], booking['coords'], 2015, 5);
          };
          len_b = bookings_queue.length;
          console.log("booking queue dump %d -> %d", len_a, len_b);
        }
        
        // 根据队列长度动态调成timeout的毫秒数
        dynamicDisplayInterval = displayInterval;
        if (bookings_queue.length > 100)
        {
          dynamicDisplayInterval = 5;
          console.log('[dynamic interval] 3. SET %dms (%d)', dynamicDisplayInterval, bookings_queue.length);
        }
        else if (bookings_queue.length > 50)
        {
          dynamicDisplayInterval = Math.floor(syncInterval/(bookings_queue.length+1));
          console.log('[dynamic interval] 2. CALC %dms (%d/%d)', dynamicDisplayInterval, syncInterval, bookings_queue.length);
        }
        else
        {
          console.log('[dynamic interval] 1. default %dms (%d)', dynamicDisplayInterval, bookings_queue.length);
        }

        setTimeout(displayTimer, dynamicDisplayInterval);
      }

      function storeAsyncRespData(data) {
        status = data['result'];
        if (status != 0) {
          return;
        }
        
        books_dict = data['data'];
        in_cnt = 0;

        outer_queue = [];
        for (var key in books_dict) {
          in_cnt++;
          value = books_dict[key];
          item = {
            'city': key,
            'city_name': value['city_name'],
            'coords': [
              value['latitude'],
              value['longitude']
              ],
            'number': value['number']
          }

          // 分解城市number到多条记录
          inner_queue = [];
          for (var i = 0; i < value['number']; i++) {
            inner_queue.push(item);
          };
          outer_queue = outer_queue.concat(inner_queue);

          //console.log('IN '+in_cnt.toString()+'-'+JSON.stringify(item));
        }

        // 对本次装载队列进行随机排序
        outer_queue = shuffle(outer_queue);
        bookings_queue = bookings_queue.concat(outer_queue);

        // console窗口输出
        //console.log('IN '+JSON.stringify(data));
        console.log('IN count '+in_cnt.toString()+' queue '+bookings_queue.length.toString());
      }

      function errorHandler(data) {
        status = data;
        console.log('booking info async request failed - status '+status);
      }

      function shuffle(array) {
        var currentIndex = array.length, temporaryValue, randomIndex ;

        // While there remain elements to shuffle...
        while (0 !== currentIndex) {

          // Pick a remaining element...
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex -= 1;

          // And swap it with the current element.
          temporaryValue = array[currentIndex];
          array[currentIndex] = array[randomIndex];
          array[randomIndex] = temporaryValue;
        }

        return array;
      }

      // ------------- 动画展示 -------------

      function displayAOrder(city, coords, year, month) {
        document.getElementById('city_board').innerHTML = city;

        var location = new google.maps.LatLng(coords[0], coords[1]);

        var outer = new google.maps.Marker({
          position: location,
          clickable: false,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillOpacity: 0.5,
            fillColor: colors[0],
            strokeOpacity: 1.0,
            strokeColor: colors[0],
            strokeWeight: 1.0,
            scale: 0,
          },
          optimized: false,
          //zIndex: year,
          map: map
        });

        var inner = new google.maps.Marker({
          position: location,
          clickable: false,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillOpacity: 1.0,
            fillColor: colors[0],
            strokeWeight: 0,
            scale: 0
          },
          optimized: false,
          //zIndex: year
        });
        //inner.year = year;

        //markersByMonth[month - 1].push(inner);

        for (var i = 0; i <= 10; i++) {
          setTimeout(setScale(inner, outer, i / 10), i * 60);
        }
      }

      function setScale(inner, outer, scale) {
        return function() {
          if (scale == 1) {
            outer.setMap(null);
          } else {
            var icono = outer.get('icon');
            icono.strokeOpacity = Math.cos((Math.PI/2) * scale);
            icono.fillOpacity = icono.strokeOpacity * 0.5;
            icono.scale = Math.sin((Math.PI/2) * scale) * 15;
            outer.set('icon', icono);

            var iconi = inner.get('icon');
            var newScale = (icono.scale < 2.0 ? 0.0 : 2.0);
            if (iconi.scale != newScale) {
              iconi.scale = newScale;
              inner.set('icon', iconi);
              if (!inner.getMap()) inner.setMap(map);
            }
          }
        }
      }

      function fillColorArray() {
        var max = 198;
        for (var i = 0; i < 44; i++) {
          if (i < 11) { // red to yellow
            r = max;
            g = Math.floor(i * (max / 11));
            b = 0;
          } else if (i < 22) { // yellow to green
            r = Math.floor((22 - i) * (max / 11));
            g = max;
            b = 0;
          } else if (i < 33) { // green to cyan
            r = 0;
            g = max;
            b = Math.floor((i - 22) * (max / 11));
          } else { // cyan to blue
            r = 0;
            g = Math.floor((44 - i) * (max / 11));
            b = max;
          }
          colors[i] = 'rgb(' + r + ',' + g + ',' + b + ')';
        }
      }
    </script>

  </head>
  <body onload="initialize()">
    <div id="map_canvas" style="width:100%; height:100%"></div>
    <div id="map_title">酒店搜索实时展示</div>
    <div id="city_board">北京</div>
    <!--
    <div id="footer"></div>
    -->
  </body>
</html>
